<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Admin NEON Cloud</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: #e5e7eb; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: #111827; padding: 20px; border-radius: 12px; border: 1px solid #1f2937; margin-bottom: 20px; }
        select, textarea, input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; box-sizing: border-box; }
        textarea { height: 450px; font-family: monospace; }
        button { background: #2563eb; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background: #1d4ed8; }
        .btn-red { background: #dc2626; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        header { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>Neon Database Manager</h2>
        <button onclick="Auth.logout(); location.href='login.html'" style="width: auto;">Sair</button>
    </header>

    <div class="card">
        <label>Projeto:</label>
        <div class="grid">
            <select id="projectSelect" onchange="loadProject()"></select>
            <button onclick="createNew()" style="background: #334155">+ Novo Projeto</button>
        </div>
    </div>

    <div class="card">
        <label>Editor HTML (Neon Cloud):</label>
        <textarea id="editor"></textarea>
        <div class="grid">
            <button id="btnSave" onclick="save()">SALVAR NO BANCO DE DADOS</button>
            <button onclick="window.open('index.html?project='+document.getElementById('projectSelect').value)" style="background: #334155">VER SITE</button>
        </div>
        <button onclick="deleteProj()" class="btn-red">Eliminar Projeto</button>
    </div>
</div>

<script src="core/auth.js"></script>
<script>
    if(!Auth.isLogged() || !Auth.isAdmin()){ 
        const pin = prompt("PIN:"); 
        if(!Auth.elevate(pin)) location.href="login.html"; 
    }

    async function fetchDB(data) {
        return fetch("/.netlify/functions/manage-db", {
            method: "POST",
            body: JSON.stringify(data)
        });
    }

    async function listProjects() {
        const res = await fetchDB({ action: 'get_list' });
        const list = await res.json();
        const select = document.getElementById("projectSelect");
        select.innerHTML = "";
        list.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.slug; opt.textContent = p.nome;
            select.appendChild(opt);
        });
        if(list.length > 0) loadProject();
    }

    async function loadProject() {
        const slug = document.getElementById("projectSelect").value;
        const res = await fetchDB({ action: 'load', slug: slug });
        const data = await res.json();
        document.getElementById("editor").value = data.html;
    }

    async function save() {
        const btn = document.getElementById("btnSave");
        btn.innerText = "A GUARDAR...";
        const slug = document.getElementById("projectSelect").value;
        const html = document.getElementById("editor").value;
        
        await fetchDB({ action: 'save', slug, nome: slug.toUpperCase(), html });
        btn.innerText = "SALVAR NO BANCO DE DADOS";
        alert("Sincronizado com Neon!");
    }

    function createNew() {
        const name = prompt("Nome do projeto:");
        if(!name) return;
        const slug = name.toLowerCase().replace(/\s+/g, '-');
        document.getElementById("editor").value = "<h1>" + name + "</h1>";
        // Adiciona temporariamente ao select e foca
        const opt = document.createElement("option");
        opt.value = slug; opt.textContent = name;
        document.getElementById("projectSelect").appendChild(opt);
        document.getElementById("projectSelect").value = slug;
    }

    async function deleteProj() {
        if(!confirm("Certeza?")) return;
        await fetchDB({ action: 'delete', slug: document.getElementById("projectSelect").value });
        listProjects();
    }

    listProjects();
</script>
</body>
</html>
