<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Neon Cloud</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: #e5e7eb; padding: 20px; }
        .card { background: #111827; padding: 20px; border-radius: 12px; border: 1px solid #1f2937; margin-bottom: 20px; }
        select, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; box-sizing: border-box; }
        textarea { height: 450px; font-family: monospace; border-left: 4px solid #2563eb; }
        button { background: #2563eb; font-weight: bold; cursor: pointer; border: none; }
        .btn-red { background: #dc2626; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Neon Database Manager</h2>
    <div class="grid">
        <select id="projectSelect" onchange="load()"></select>
        <button onclick="createNew()" style="background: #334155">+ Novo Projeto</button>
    </div>
</div>

<div class="card">
    <textarea id="editor" placeholder="Código HTML..."></textarea>
    <div class="grid">
        <button id="btnSave" onclick="save()">SALVAR NO BANCO</button>
        <button onclick="window.open('index.html?project='+document.getElementById('projectSelect').value)" style="background: #334155">VER SITE</button>
    </div>
    <button onclick="deleteProj()" class="btn-red" style="margin-top:10px">Eliminar Projeto</button>
</div>

<script src="core/auth.js"></script>
<script>
    if(!Auth.isLogged()) location.href="login.html";

    const select = document.getElementById("projectSelect");
    const editor = document.getElementById("editor");
    const btnSave = document.getElementById("btnSave");

    async function api(data) {
        const res = await fetch("/.netlify/functions/manage-db", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        return res.json();
    }

    async function list() {
        const data = await api({ action: 'get_list' });
        select.innerHTML = "";
        data.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.slug; opt.textContent = p.nome;
            select.appendChild(opt);
        });
        if(data.length > 0) load();
    }

    async function load() {
        const data = await api({ action: 'load', slug: select.value });
        editor.value = data.html || "";
    }

    async function save() {
        btnSave.innerText = "⏳ SALVANDO...";
        try {
            await api({ 
                action: 'save', 
                slug: select.value, 
                nome: select.value.toUpperCase(), 
                html: editor.value 
            });
            alert("✅ Salvo no Neon!");
        } catch(e) { alert("Erro ao salvar."); }
        btnSave.innerText = "SALVAR NO BANCO";
    }

    function createNew() {
        const name = prompt("Nome do projeto:");
        if(!name) return;
        const slug = name.toLowerCase().replace(/\s+/g, '-');
        const opt = document.createElement("option");
        opt.value = slug; opt.textContent = name;
        select.appendChild(opt);
        select.value = slug;
        editor.value = "<h1>" + name + "</h1>";
    }

    async function deleteProj() {
        if(!confirm("Deletar?")) return;
        await api({ action: 'delete', slug: select.value });
        list();
    }

    list();
</script>
</body>
</html>
