<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo Neon</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: #e5e7eb; padding: 20px; }
        .card { background: #111827; padding: 20px; border-radius: 12px; border: 1px solid #1f2937; margin-bottom: 20px; }
        select, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; box-sizing: border-box; }
        textarea { height: 400px; font-family: monospace; border-left: 4px solid #2563eb; }
        button { background: #2563eb; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background: #1d4ed8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Gerenciador de Projetos (Neon)</h2>
    <div class="grid">
        <select id="projectSelect" onchange="load()"></select>
        <button onclick="createNew()" style="background: #334155">+ Novo Projeto</button>
    </div>
</div>

<div class="card">
    <textarea id="editor" placeholder="Código HTML aqui..."></textarea>
    <button id="btnSave" onclick="save()">SALVAR NO BANCO DE DADOS</button>
</div>

<script src="core/auth.js"></script>
<script>
    // Se não estiver logado, volta pro login
    if(!Auth.isLogged()) location.href = "login.html";

    const select = document.getElementById("projectSelect");
    const editor = document.getElementById("editor");
    const btn = document.getElementById("btnSave");

    async function api(data) {
        const res = await fetch("/.netlify/functions/manage-db", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        return res.json();
    }

    async function list() {
        const projects = await api({ action: 'get_list' });
        select.innerHTML = "";
        projects.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.slug; opt.textContent = p.nome;
            select.appendChild(opt);
        });
        if(projects.length > 0) load();
    }

    async function load() {
        const data = await api({ action: 'load', slug: select.value });
        editor.value = data.html || "";
    }

    async function save() {
        btn.innerText = "⏳ A GUARDAR...";
        btn.disabled = true;
        
        try {
            await api({ 
                action: 'save', 
                slug: select.value, 
                nome: select.value.toUpperCase(), 
                html: editor.value 
            });
            alert("✅ Salvo com sucesso no Neon!");
        } catch (e) {
            alert("❌ Erro ao salvar. Verifique os logs do Netlify.");
        } finally {
            btn.innerText = "SALVAR NO BANCO DE DADOS";
            btn.disabled = false;
        }
    }

    function createNew() {
        const n = prompt("Nome do projeto:");
        if(!n) return;
        const s = n.toLowerCase().replace(/\s+/g, '-');
        const opt = document.createElement("option");
        opt.value = s; opt.textContent = n;
        select.appendChild(opt);
        select.value = s;
        editor.value = "<h1>" + n + "</h1>";
    }

    list();
</script>
</body>
</html>
