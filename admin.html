<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo Pro | LUGH LT</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e5e7eb; padding: 20px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1e293b; padding-bottom: 20px; margin-bottom: 20px; }
        
        .section { background: #111827; padding: 20px; border-radius: 12px; border: 1px solid #1f2937; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #94a3b8; }
        
        select, textarea, input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 14px; box-sizing: border-box; }
        textarea { height: 400px; font-family: 'Consolas', monospace; resize: vertical; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: #2563eb; color: white; width: 100%; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #334155; color: white; }
        .btn-secondary:hover { background: #475569; }
        .btn-danger { background: #dc2626; color: white; margin-top: 10px; width: 100%; }
        
        .status-badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #1e293b; color: #3b82f6; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h2>Gerenciador de Projetos</h2>
            <span class="status-badge" id="user-display">Carregando...</span>
        </div>
        <button onclick="logout()" class="btn-secondary">Sair</button>
    </header>

    <div class="section">
        <label>Selecionar Projeto:</label>
        <div class="grid">
            <select id="projectSelect" onchange="loadProjectHTML()"></select>
            <button onclick="createNewProject()" class="btn-secondary">+ Criar Novo</button>
        </div>
    </div>

    <div class="section">
        <label>Código HTML do Projeto:</label>
        <textarea id="editor" placeholder="Cole o código HTML da sua loja aqui..."></textarea>
        
        <div class="grid">
            <button id="btnSave" onclick="saveToGithub()" class="btn-primary">SALVAR NO GITHUB</button>
            <button onclick="preview()" class="btn-secondary">VISUALIZAR</button>
        </div>
        
        <button onclick="deleteProject()" class="btn-danger">Excluir Projeto Selecionado</button>
    </div>
</div>

<script src="core/auth.js"></script>
<script src="core/storage.js"></script>

<script>
    // 1. Verificação de Acesso
    if(!Auth.isLogged()) { location.href = "login.html"; }
    
    if(!Auth.isAdmin()) {
        const pin = prompt("Segurança: Digite o PIN de administrador:");
        if(!Auth.elevate(pin)) {
            alert("PIN Incorreto!");
            location.href = "index.html";
        }
    }

    document.getElementById("user-display").innerText = "Usuário: " + Auth.currentUser();

    const select = document.getElementById("projectSelect");
    const editor = document.getElementById("editor");
    const btnSave = document.getElementById("btnSave");

    // 2. Gestão da Lista de Projetos
    function getList() {
        return Storage.get("app_projects_list") || ["lughlt"];
    }

    function refreshSelect() {
        const list = getList();
        select.innerHTML = "";
        list.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p; opt.textContent = p.toUpperCase();
            select.appendChild(opt);
        });
    }

    async function loadProjectHTML() {
        const slug = select.value;
        editor.value = "Carregando conteúdo...";
        
        // Tenta carregar do Storage primeiro (cache local), se não busca o arquivo real
        const local = Storage.get("project_html_" + slug);
        if(local) {
            editor.value = local;
        } else {
            try {
                const res = await fetch(`projects/${slug}/index.html`);
                if(res.ok) {
                    const text = await res.text();
                    editor.value = text;
                } else {
                    editor.value = "";
                }
            } catch(e) {
                editor.value = "";
            }
        }
    }

    // 3. Criar e Deletar
    function createNewProject() {
        const name = prompt("Nome do projeto (apenas letras e números, sem espaços):");
        if(!name) return;
        const slug = name.toLowerCase().trim().replace(/\s+/g, '-');
        
        const list = getList();
        if(list.includes(slug)) return alert("Este nome já existe!");
        
        list.push(slug);
        Storage.set("app_projects_list", list);
        refreshSelect();
        select.value = slug;
        editor.value = `<h1>Bem-vindo ao projeto ${name}</h1>`;
        saveToGithub(); // Cria o arquivo no GitHub automaticamente
    }

    // 4. SALVAR VIA NETLIFY FUNCTION (BACKEND)
    async function saveToGithub() {
        const slug = select.value;
        const content = editor.value;

        btnSave.innerText = "⏳ SINCRONIZANDO...";
        btnSave.disabled = true;

        try {
            const response = await fetch("/.netlify/functions/save-project", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    slug: slug,
                    content: content
                })
            });

            if (response.ok) {
                Storage.set("project_html_" + slug, content);
                alert("✅ SUCESSO! O GitHub foi atualizado e o Netlify está publicando as alterações.");
            } else {
                const err = await response.text();
                alert("❌ Erro ao salvar: " + err);
            }
        } catch (error) {
            alert("❌ Erro de conexão com o servidor.");
        } finally {
            btnSave.innerText = "SALVAR NO GITHUB";
            btnSave.disabled = false;
        }
    }

    function preview() {
        window.open(`index.html?project=${select.value}`, "_blank");
    }

    function logout() {
        Auth.logout();
        location.href = "login.html";
    }

    // Início
    refreshSelect();
    loadProjectHTML();
</script>

</body>
</html>
